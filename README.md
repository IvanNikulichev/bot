features.parquet — таблица признаков для обучения/инференса ранкера. Внутри по каждой паре «запрос-POI» лежат дистанции, бины по времени, флаги по типам мест, текстовые совпадения и т. п. Формируется скриптом build_features.py.

geo_utils.py — извлечение старта из свободного текста: координаты, подсказки адреса, нормализация, фолы к Nominatim. Используется ботом до расчёта маршрута.

geocode_from_text_smart.py — оффлайн-эвристики для вытаскивания координат/адресов из фраз для датасета (без Telegram). Ускоряет подготовку запросов.

geocode_starts.py — простые правила для получения стартовых точек из разметки/черновиков. Резерв к smart-версии.

inference_snippet.py — минимальный пример применения обученной модели для ранжирования поданного пула POI (без бота). Полезно для быстрых sanity-checks.

make_categories.py — утилита, которая по описанию/тегам дописывает к POI набор категорий (interest-метки). Эти метки потом влияют на фичи интересов при обучении.

model_features.json — список столбцов признаков и их порядок, на которых обучен CatBoost. Загружается тренером/инференсом, чтобы не «потерять» согласование между обучением и продом.

nn_streets.txt — словарь улиц НН для локального матчинга адресов в тексте без онлайн-геокодера.

parse_queries.py — преобразование сырых фраз пользователей в структурированный csv с полями text, hours, start_lat/lon, interests_set.

PIO.txt — рабочий файл с заметками/подсказками по POI (описания, ручные правки). Используется при разметке категорий и проверке.

poi_csv.csv — основной справочник точек интереса: id, title, coordinate/lat/lon, description, tags, kind, popularity и пр. Источник правды для расчёта.

poi_ranker.cbm — обученная CatBoost-модель ранжирования (YetiRankPairwise). Её грузит бот при старте для скоринга кандидатов.

poi_with_categories.csv — тот же справочник POI, но с колонкой categories (список интересов на объект). Подмешивается в build_features.py для учёта интересов.

queries_geo.csv — размеченные запросы с уже известными стартовыми координатами и, при наличии, интересами/временем.

queries_parsed.csv — результат parse_queries.py: очищенный текст, извлечённые часы/интересы, черновые координаты.

queries_raw.csv — сырой лог фраз. Вход для парсера/геокодера.

requirements.txt — pinned-зависимости (aiogram, pandas, catboost, numpy и т. п.) для воспроизводимых окружений.

script.py — мелкие одноразовые процедуры для конверта/склейки файлов (ad-hoc).

sintetic.txt — набор синтетических фраз-«якорей» для улучшения извлечения адресов/интересов.

target_to_csv.py — выгрузка целевой разметки/меток в csv для отладки обучения.

to_csv.py — вспомогательная конвертация между parquet/csv по нужным колонкам.

build_features.py — генератор обучающих/инференс-фич. Грузит запросы и POI, аккуратно приводит типы, подтягивает категории, считает дистанции и инженерит признаки: числовые, бинарные, бины по времени, флаги по kind, оверлап по интересам; на выход отдаёт features.parquet. Ключевые моменты: безопасные касты к числам/строкам, парсинг WKT координат, stay_min = 30 мин для park, поддержка внешнего CSV с категориями.

train_ranker.py — обучение CatBoostRanker на features.parquet. Делит по query-группам, использует YetiRankPairwise, берёт список признаков из model_features.json, сохраняет модель в poi_ranker.cbm. При отсутствии «y» синтетически строит метку на основе близости и совпадения интересов, чтобы не зависеть от полноценной ручной разметки.

bot.py — Telegram-бот. Парсит ввод (адрес/координаты, часы, интересы), формирует пул кандидатов из poi_csv.csv, скорит их CatBoost-моделью, усиливает вес совпадений по категориям, собирает маршрут под заданное время с шагами пешком и временем на остановках, формирует ответ + ссылку на маршрут в Яндекс.Картах. Делает разбиение длинных сообщений под лимит Telegram.

Почему этот подход стоит использовать:

Разделение задач. Отдельно: подготовка данных → инженерия признаков → обучение → инференс в боте. Это снижает связность и упрощает отладку.

Воспроизводимость. model_features.json фиксирует договорённость по фичам, parquet хранит «истину» для тренировки, weights версионируются в poi_ranker.cbm.

Устойчивость к шуму. build_features.py жёстко приводит типы, даёт дефолты, терпит отсутствие колонок и умеет брать категории из отдельного csv. Это уменьшает «падают на касте» и ускоряет эксперименты.

Баланс правил и ML. Бот использует модель, но дополнительно учитывает интересы и жесткие бизнес-правила (время стоянки в парках, лимиты по скорости/числу точек). Это даёт предсказуемость при сохранении качества.

Простота расширения. Добавить новое поле/фичу → правка build_features.py и (при необходимости) пересохранить model_features.json, переобучить модель; бот останется неизменным на API модели.